<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WPAN Gateway: Platform configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">WPAN Gateway
   </div>
   <div id="projectbrief">A low-power border router</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Platform configuration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This project uses Buildroot. Buildroot is a toolchain that simplifies custom Linux target creation. It is available on the <a href="https://buildroot.org/">Buildroot project website</a>. It is an archive to be downloaded and compiled on another host system. It also provides cross-compilers. These are useful to quickly compile the Linux kernel and whatever program to be developped using the host machine's considerably higher computing power.</p>
<p>The reason Buildroot is interesting is that it allows easy configuration of a custom Linux system. We can tinker with the kernel and configurations in order to only get the functionalities we need. This allows faster boot times and security upgrades.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Buildroot configuration and initial build</h1>
<p>Initial setup is easy per <a href="https://buildroot.org/downloads/manual/manual.html#getting-buildroot">the Buildroot manual</a>:</p><ol type="1">
<li>Check that the host PC has all the <a href="https://buildroot.org/downloads/manual/manual.html#requirement-mandatory">required packages</a>.</li>
<li>Download and extract Buildroot from the <a href="http://buildroot.org/downloads/">Buildroot downloads page</a>.</li>
</ol>
<p>Once again, most of the work has been done for us, in the form of default configurations to save us the tough work of configuring everything ourselves. Our target, the Raspberry Pi CM4, has a lot of community support</p>
<ol type="1">
<li>List available default configurations by running this command in the buildroot root folder: <div class="fragment"><div class="line">make list-defconfigs</div>
</div><!-- fragment --> Bingo! There is a default configuration for the Pi CM4: <div class="fragment"><div class="line">raspberrypicm4io_defconfig</div>
</div><!-- fragment --></li>
<li>Configure Buildroot for the Pi CM4: <div class="fragment"><div class="line">make raspberrypicm4io_defconfig</div>
</div><!-- fragment --></li>
<li>Build the kernel and toolchain (can take over an hour the first time, be patient): <div class="fragment"><div class="line">make all</div>
</div><!-- fragment --></li>
<li>Configure Buildroot: <div class="fragment"><div class="line">make menuconfig</div>
</div><!-- fragment --></li>
<li>Configure Linux: <div class="fragment"><div class="line">make linux-menuconfig</div>
</div><!-- fragment --></li>
<li>Build the toolchain: <div class="fragment"><div class="line">make</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md6"></a>
Flashing the built Linux</h1>
<p>Buildroot creates a complete SD card image for us. We can easily flash it with a dedicated script.</p>
<div class="fragment"><div class="line">#!/bin/sh</div>
<div class="line">SD_ROOT_FOLDER=/dev/sda # Modify according to your SD path (use lsblk to find it)</div>
<div class="line"> </div>
<div class="line">sudo umount $SD_ROOT_FOLDER</div>
<div class="line">#initialize 960MiB to 0</div>
<div class="line">sudo dd if=/dev/zero of=$SD_ROOT_FOLDER count=240000</div>
<div class="line">sudo dd if=output/images/sdcard.img of=$SD_ROOT_FOLDER # flash SD image</div>
<div class="line">sudo umount -r ${SD_ROOT_FOLDER}1</div>
<div class="line">sudo umount -r ${SD_ROOT_FOLDER}2</div>
<div class="line">sudo umount -r ${SD_ROOT_FOLDER}1 # Twice to get umount confirmation</div>
<div class="line">sudo umount -r ${SD_ROOT_FOLDER}2</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7"></a>
Platform configuration</h1>
<h2><a class="anchor" id="autotoc_md8"></a>
Getting a serial terminal</h2>
<div class="fragment"><div class="line">make menuconfig</div>
</div><!-- fragment --><p> Go to "System configuration" -&gt; "Run a getty after boot" and set the "TTY port" to ttyACM0, "Baudrate" to 115200 and "TERM environment variable" to vt100 per <a href="https://ltekieli.com/buildroot-with-raspberry-pi-what-where-and-how/">this article</a>. Modify /boot/cmdline.txt on your SD card and add the following line: </p><div class="fragment"><div class="line">console=ttyAMA0,115200 root=/dev/mmcblk0p2 rootwait</div>
</div><!-- fragment --><p> Getting a serial terminal means you can see boot messages from a console application like minicom. This is particularly useful in the early stages of development when network configurations may not be operational making SSH impossible. We can better troubleshoot kernel panics (they will happen some day).</p>
<p>Connect to the CM4 with an USB serial adapter connected to <a href="schema_cm4.PDF">UART0</a>. You may need to cross RX with TX if the default wiring does not work.</p>
<p>Use minicom or another serial program: </p><div class="fragment"><div class="line">minicom -b 115200 -D /dev/ttyUSB0 # replace /dev/ttyUSB0 with your device</div>
</div><!-- fragment --><p> To find your device, compare </p><div class="fragment"><div class="line">ls /dev</div>
</div><!-- fragment --><p> output before and after plugging the USB to serial adapter.</p>
<p>See below an example of wiring.</p>
<div class="image">
<img src="serial.jpg" alt="" height="400"/>
<div class="caption">
Wiring example</div></div>
 <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Signal   </th><th class="markdownTableHeadLeft">Color    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GND   </td><td class="markdownTableBodyLeft">Brown    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">RX   </td><td class="markdownTableBodyLeft">Orange    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">TX   </td><td class="markdownTableBodyLeft">Yellow   </td></tr>
</table>
<p>Connecting +5V is not necessary and could theoretically lead to problems. It is safe in most applications. Using a USB-to-serial adapter to power the CM4 is not recommended. The kernel will display undervoltage alerts.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Network configuration</h2>
<p>We need to configure the network in order to use SSH. The CM4 board has Ethernet and Wi-Fi capabilities. Ethernet does not require installing packages. Wi-Fi requires the following configuration (per <a href="https://blog.crysys.hu/2018/06/enabling-wifi-and-converting-the-raspberry-pi-into-a-wifi-ap/">this article</a>): </p><div class="fragment"><div class="line">make menuconfig</div>
</div><!-- fragment --><p> Allow automatic loading of wireless driver:</p><ul>
<li>System configuration -&gt; /dev management -&gt; Dynamic using devtmpfs + mdev</li>
</ul>
<p>Install onboard Wi-Fi firmware:</p><ul>
<li>Target packages -&gt; Hardware handling -&gt; Firmware -&gt; rpi 4 (extended)</li>
<li>Target packages -&gt; Hardware handling -&gt; Firmware -&gt; bcrmfmac-sdio-firmware-rpi</li>
</ul>
<p>Install Wi-Fi configuration packages:</p><ul>
<li>Target packages -&gt; Networking applications -&gt; iw</li>
<li>Target packages -&gt; Networking applications -&gt; wpa-supplicant -&gt; Enable nl80211 support</li>
<li>Target packages -&gt; Networking applications -&gt; wpa_supplicant -&gt; Install wpa_passphrase binary (optional)</li>
</ul>
<p>Install RF switch into kernel and not as a module: </p><div class="fragment"><div class="line">make linux-menuconfig</div>
</div><!-- fragment --><ul>
<li>Networking support -&gt; RF switch subsystem support (Y)</li>
</ul>
<p>Configuration of network interfaces is done by modifying /etc/network/interfaces. Find below a sample configuration for a static Ethernet address and a DHCP Wi-Fi address.</p>
<div class="fragment"><div class="line">auto lo</div>
<div class="line">iface lo inet loopback</div>
<div class="line"> </div>
<div class="line">auto eth0</div>
<div class="line">iface eth0 inet static</div>
<div class="line">    address 192.168.0.10</div>
<div class="line">    gateway 192.168.0.1</div>
<div class="line">    netmask 255.255.255.0</div>
<div class="line"> </div>
<div class="line">auto wlan0</div>
<div class="line">iface wlan0 inet dhcp</div>
<div class="line">    pre-up wpa_supplicant -D nl80211 -i wlan0 -c /etc/wpa_supplicant.conf -B</div>
<div class="line">    post-down killall -q wpa_supplicant</div>
<div class="line">    wait-delay 15</div>
<div class="line">iface default inet dhcp</div>
</div><!-- fragment --><p>WPA configuration is done by editing /etc/wpa_supplicant.conf or using the wpa_passphrase utility: </p><div class="fragment"><div class="line">country=CH</div>
<div class="line">update_config=1</div>
<div class="line"> </div>
<div class="line">network={</div>
<div class="line">    ssid=&quot;WIFINAME&quot;</div>
<div class="line">    psk=&quot;PASSWORD&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
SSH configuration</h2>
<p>Buildroot ships Dropbear as the default SSH client. It is a lightweight client. We chose to use OpenSSH to get an easier time setting up SSH keys. To remove Dropbear and install OpenSSH: </p><div class="fragment"><div class="line">make menuconfig</div>
</div><!-- fragment --><p> Uncheck Dropbear:</p><ul>
<li>Target packages-&gt;Networking applications-&gt;dropbear</li>
</ul>
<p>Check OpenSSH client, server and key utilities packages:</p><ul>
<li>Target packages-&gt;Networking applications-&gt;openssh</li>
</ul>
<p>SSH keys should be stored in ~/.ssh and accessible only by root user. We need to create the .ssh folder in rootfs_overlay, populate it with the generated authorized_keys file and set its permissions.</p>
<p>Set the permissions by editing buildroot/system/device_table.txt: </p><div class="fragment"><div class="line">#path                    type  perms</div>
<div class="line">/root/.ssh/                d   700 0   0   -   -   -   -   -</div>
<div class="line">/root/.ssh/authorized_keys f   600 0   0   -   -   -   -   -</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
Debugging programs</h2>
<div class="fragment"><div class="line">make menuconfig</div>
</div><!-- fragment --><p> Per <a href="https://www.oreilly.com/library/view/mastering-embedded-linux/9781787283282/43e79c1d-f609-456d-841e-41c595245c5e.xhtml">this book snippet</a>:</p><ul>
<li>Toolchain -&gt; Build cross gdb for the host</li>
<li>Toolchain -&gt; Enable WCHAR support</li>
<li>Toolchain -&gt; Thread library debugging</li>
<li>Target packages -&gt; Debugging, profiling and benchmark -&gt; gdb</li>
<li>Target packages -&gt; Debugging, profiling and benchmark -&gt; gdbserver</li>
<li>Target packages -&gt; Debugging, profiling and benchmark -&gt; full debugger</li>
</ul>
<p>Using the debugger (per <a href="https://buildroot.org/downloads/manual/using-buildroot-debugger.txt">buildroot manual</a>):</p>
<p>On the CM4: </p><div class="fragment"><div class="line">gdbserver :2345 [PROGRAM] # GDB server listens on TCP port 2345</div>
</div><!-- fragment --><p> On the host PC, from cross-compilation directory: </p><div class="fragment"><div class="line">&lt;buildroot&gt;/output/host/bin/&lt;tuple&gt;-gdb -ix &lt;buildroot&gt;/output/staging/usr/share/buildroot/gdbinit [CROSSCOMPILED_PROGRAM]</div>
<div class="line">(gdb) target remote &lt;target ip address&gt;:2345 # Connect to gdb server</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
Device tree overlay</h1>
<p>The device tree overlay is a file that describes the hardware setup so that Linux can know where its peripherals are. It doesn't describe all hardware by default, to keep a lightweight system.</p>
<p>Since the gateway application uses the CM4's serial device 4, we have to tell Linux it exists and how. Fortunately, the tedious description work has already been done for us. All we need to do is add the following line at the end of /boot/ dtoverlay.</p>
<div class="fragment"><div class="line"># enable UART4</div>
<div class="line">dtoverlay=uart4</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
Saving linux configuration in Buildroot</h1>
<h2><a class="anchor" id="autotoc_md14"></a>
Rootfs overlay</h2>
<p>To have your Linux configuration kept by Buildroot instead of resetting it on build, <a href="https://boozlachu.medium.com/buildroot-part-2-bffac4b0b86a">configure and populate rootfs_overlay</a>.</p>
<p>By default, buildroot/board/raspberrypicm4io/rootfs_overlay is used. Putting any file there will have it replace the originally generated file.</p>
<p>It is possible to modify this path: </p><div class="fragment"><div class="line">make menuconfig</div>
</div><!-- fragment --><ul>
<li>System configuration -&gt; Root filesystem overlay directories</li>
</ul>
<h2><a class="anchor" id="autotoc_md15"></a>
/boot/config.txt</h2>
<p>It is possible to modify default /boot/config.txt by editing buildroot/board/raspberrycm4io/config_cm4io.txt.</p>
<p>It is thus possible to add the UART4 device tree overlay as described before:</p>
<div class="fragment"><div class="line"># enable UART4</div>
<div class="line">dtoverlay=uart4</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md16"></a>
Network configuration</h2>
<p>Persistent network configuration changes can be kept by editing buildroot/board/raspberrycm4io/interfaces. This file matches /etc/network/interfaces on the Linux image. It is copied after building (see post-build script) The current configuration uses DHCP for the Wi-Fi interface and static addressing for Ethernet.</p>
<div class="fragment"><div class="line">auto lo</div>
<div class="line">iface lo inet loopback</div>
<div class="line"> </div>
<div class="line">auto eth0</div>
<div class="line">#iface eth0 inet dhcp</div>
<div class="line">iface eth0 inet static</div>
<div class="line">    address 192.168.0.10</div>
<div class="line">    gateway 192.168.0.1</div>
<div class="line">    netmask 255.255.255.0</div>
<div class="line">    #pre-up /etc/network/nfs_check</div>
<div class="line">    #wait-delay 15</div>
<div class="line">    #metric 100</div>
<div class="line"> </div>
<div class="line">auto wlan0</div>
<div class="line">iface wlan0 inet dhcp</div>
<div class="line">    pre-up wpa_supplicant -D nl80211 -i wlan0 -c /etc/wpa_supplicant.conf -B</div>
<div class="line">    post-down killall -q wpa_supplicant</div>
<div class="line">    wait-delay 15</div>
<div class="line">#    metric 100</div>
<div class="line">iface default inet dhcp</div>
</div><!-- fragment --><p>WPA configuration is in buildroot/board/raspberrycm4io/wpa_supplicant.conf. This file matches /etc/wpa_supplicant.conf. It is called on configuration of network interfaces. Find below an example configuration:</p>
<div class="fragment"><div class="line">country=CH</div>
<div class="line">update_config=1</div>
<div class="line"> </div>
<div class="line">network={</div>
<div class="line">    ssid=&quot;WIFINAME&quot;</div>
<div class="line">    psk=&quot;PASSWORD&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md17"></a>
Post-build script</h2>
<p>Sometimes it is not possible to put configs in rootfs_overlay. We can use the post_build.sh script in board/raspberrypicm4io/post-build.sh to apply any change we want to the built image before it is created.</p>
<p>The script is executed <a href="https://buildroot.org/downloads/manual/manual.html#rootfs-custom">before imaging, but after building</a>.</p>
<div class="fragment"><div class="line">#!/bin/sh</div>
<div class="line"> </div>
<div class="line"> set -u</div>
<div class="line"> set -e</div>
<div class="line"> </div>
<div class="line"> # Add a console on tty1</div>
<div class="line"> if [ -e ${TARGET_DIR}/etc/inittab ]; then</div>
<div class="line">     grep -qE &#39;^tty1::&#39; ${TARGET_DIR}/etc/inittab || \</div>
<div class="line">    sed -i &#39;/GENERIC_SERIAL/a\</div>
<div class="line"> tty1::respawn:/sbin/getty -L  tty1 0 vt100 # HDMI console&#39; ${TARGET_DIR}/etc/inittab</div>
<div class="line"> fi</div>
<div class="line"> </div>
<div class="line"> # enable wi-fi per</div>
<div class="line"> #https://blog.crysys.hu/2018/06/enabling-wifi-and-converting-the-raspberry-pi-</div>
<div class="line"> #in t-o-a-wifi-ap/</div>
<div class="line"> cp package/busybox/S10mdev ${TARGET_DIR}/etc/init.d/S10mdev</div>
<div class="line"> chmod 755 ${TARGET_DIR}/etc/init.d/S10mdev</div>
<div class="line"> cp package/busybox/mdev.conf ${TARGET_DIR}/etc/mdev.conf</div>
<div class="line"> cp board/raspberrypicm4io/interfaces ${TARGET_DIR}/etc/network/interfaces</div>
<div class="line"> cp board/raspberrypicm4io/wpa_supplicant.conf ${TARGET_DIR}/etc/wpa_supplicant.conf</div>
</div><!-- fragment --><p>The script was modified to copy the network configurations into the relevant folders. It is probably not necessary and could be done using rootfs_overlay, but it is working. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
